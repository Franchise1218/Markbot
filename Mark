import json
import pandas as pd
import sqlite3
import random

# Personalized startup message
print(f"\nğŸ¤– Yo, it's Mark! Welcome back, Jose! Let's get this damn wrestling data rollinâ€™.")

# Connect to SQLite (Creates database if it doesn't exist)
conn = sqlite3.connect("mark_database.db")
cursor = conn.cursor()

# Ensure the DVDs table exists
cursor.execute("""
    CREATE TABLE IF NOT EXISTS dvds (
        id INTEGER PRIMARY KEY,
        disc_number TEXT,
        event_number TEXT,
        date TEXT,
        company TEXT,
        cloud TEXT,  -- Ensures Cloud is stored as TEXT
        hard_drive TEXT,
        match_listing TEXT
    )
""")
conn.commit()
conn.close()

# Search History for tracking past queries
search_history = []

# Function to search SQL database with partial matching
def search_sql_data(query):
    global search_history
    search_history.append(query)  # Track past searches

    conn = sqlite3.connect("mark_database.db")
    cursor = conn.cursor()

    cursor.execute("""
        SELECT * FROM dvds WHERE 
        disc_number LIKE ? OR event_number LIKE ? OR company LIKE ? OR match_listing LIKE ? OR cloud LIKE ?
    """, ('%'+query+'%', '%'+query+'%', '%'+query+'%', '%'+query+'%', '%'+query+'%'))

    results = cursor.fetchall()
    conn.close()

    if results:
        response = f"\nğŸ“€ **Here you go, boss. Pulled some damn good results for '{query}':**\n"
        response += "\n".join(
            f"ğŸ¬ Disc #: {r[1]} | Event #: {r[2]} | Date: {r[3]} | Company: {r[4]} | Cloud: {r[5]} | Matches: {r[7]}"
            for r in results
        )
    else:
        response = f"\nğŸ›‘ **Bruh, that weak-ass search ain't got nothing.** Try again."

    # Add some street flavor based on past searches
    if len(search_history) > 3:  
        response += f"\nğŸ§ **Yo, Joseâ€”you done hit up '{query}' like 3 times. You good, homie?**"
    
    return response

# Function to filter searches (Cloud entries, Disc #, Match Listings)
def search_filtered_data(filter_type):
    conn = sqlite3.connect("mark_database.db")
    cursor = conn.cursor()

    if filter_type.lower() == "cloud":
        cursor.execute("SELECT * FROM dvds WHERE cloud IS NOT NULL AND cloud != ''")  # Gets all Cloud entries
        response_tag = "ğŸŒ© Cloud Entries"
    elif filter_type.isdigit():  # Disc # search
        cursor.execute("SELECT * FROM dvds WHERE disc_number = ?", (filter_type,))
        response_tag = f"ğŸ’¿ Disc #{filter_type}"
    else:  # Allows Cloud-specific searches & Match Listings (Disc Contents)
        cursor.execute("SELECT * FROM dvds WHERE cloud LIKE ? OR match_listing LIKE ?", ('%' + filter_type + '%', '%' + filter_type + '%'))
        response_tag = f"ğŸ“œ Results for '{filter_type}'"

    results = cursor.fetchall()
    conn.close()

    return f"\nğŸ” **{response_tag}:**\n" + "\n".join(
        f"ğŸ¬ {r[3]} - {r[4]} | Cloud: {r[5]} | Disc #: {r[1]} | Matches: {r[7]}"
        for r in results
    ) if results else f"\nğŸ›‘ **Bruh, that ain't it. Try another filter.**"

# Randomized thug-style farewells
farewells = [
    "ğŸ‘Š Aight, I'm out. You handle yo' business.",
    "ğŸš€ This convo just tapped outâ€”ONE!",
    "ğŸ”¥ Cool, but I got better things to do. Holla!",
    "ğŸ’¨ Mark is signing offâ€”you deal with yo' mess."
]

# Chatbot loop with natural command detection & memory-based responses
while True:
    user_input = input("\nAsk me about wrestling data (or type 'show me Cloud', 'show me Disc #', 'show me 45A1'): ")

    if user_input.lower() in ["exit", "quit"]:
        print(random.choice(farewells))
        break

    elif user_input.lower().startswith(("filter:", "show me")):
        filter_request = user_input.split(":")[-1].strip() if "filter:" in user_input else user_input.split("show me")[-1].strip()

        # Handle Disc # properly
        if filter_request.isdigit():
            print(search_filtered_data(filter_request))
        else:
            print(search_sql_data(filter_request))  # Ensures Match Listings work too

    else:
        print(search_sql_data(user_input))
